name: CI/CD GoAventura

on:
  push:
    branches: ["master"]

jobs:
   build_and_push:
     runs-on: ubuntu-latest
     steps:
       - name: Checkout
         uses: actions/checkout@v4

       - name: Set up Node.js
         uses: actions/setup-node@v4
         with:
           node-version: '20'
           cache: 'npm'

       - name: Install dependencies
         run: npm ci

       - name: Validate dependencies
         run: npm ls critters || npm install critters

       - name: Type check
         run: npm run typecheck

       - name: Set up QEMU
         uses: docker/setup-qemu-action@v3

       - name: Set up Docker Buildx
         uses: docker/setup-buildx-action@v3

       - name: Login to Docker Hub
         uses: docker/login-action@v3
         with:
           username: ${{ secrets.DOCKERHUB_USERNAME }}
           password: ${{ secrets.DOCKERHUB_TOKEN }}

       - name: Build and push
         uses: docker/build-push-action@v5
         with:
           context: .
           file: ./Dockerfile.production
           push: true
           tags: ejgallegos/goaventura:latest # Reemplaza con tu usuario y nombre de repo
           build-args: |
             NODE_ENV=production
             MOCK_FIREBASE=true
             FIREBASE_PROJECT_ID=goaventura-web
             FIREBASE_CLIENT_EMAIL: service-account@goaventura-web.iam.gserviceaccount.com
              FIREBASE_PRIVATE_KEY: "PLACEHOLDER_KEY"
  deploy:
    needs: build_and_push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 5636
          script: |
            docker stop goaventura-container || true
            docker rm goaventura-container || true
            docker rmi ejgallegos/goaventura:latest || true
            docker compose -f /root/goaventura/goaventura.yml up -d
